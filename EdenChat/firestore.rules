rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Device registration — each device can only manage its own doc
    match /devices/{deviceId} {
      allow read: if request.auth == null || true;
      allow create: if true;
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['fcmToken', 'lastSeenAt']);
    }

    // Conversations — scoped to the device that owns them
    match /conversations/{conversationId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['deviceId', 'title']);
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['unreadCount', 'updatedAt']);

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if true;
        // Users can create messages and update status to "read"
        allow create: if request.resource.data.sender == 'user'
          && request.resource.data.keys().hasAll(['sender', 'type', 'text', 'bridgeStatus', 'createdAt'])
          && request.resource.data.bridgeStatus == 'pending';
        allow update: if request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['status']);
      }
    }

    // Presence — read-only for clients (bridge writes via Admin SDK)
    match /presence/{docId} {
      allow read: if true;
      allow write: if false;
    }
  }
}
